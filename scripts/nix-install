#!/usr/bin/env bash

# ~/.local/.bin/nix-install
# Description: Adds package(s) to `$HOME/.config/nixos/my-pkgs.nix` and executes `nixos-rebuild switch`
# Usage: sudo nix-install <package1> <package2> ...

if [ "$EUID" -ne 0 ]; then
  echo "Please run with sudo"
  exit 1
fi

if [ $# -eq 0 ]; then
  echo "Usage: sudo nix-install <package1> <package2> ..."
  exit 1
fi

MY_PKGS_FILE="/etc/nixos/my-pkgs.nix"

# Check if my-pkgs.nix exists
if [ ! -f "$MY_PKGS_FILE" ]; then
  echo "Error: $MY_PKGS_FILE not found!"
  exit 1
fi

# Loop over all the given packages
for PACKAGE in "$@"; do
  # Check if the package is already present
  if grep -qE "\s+$PACKAGE\s*" "$MY_PKGS_FILE"; then
    echo "$PACKAGE already present in my-pkgs.nix."
  else
    # Insert the package before the closing ];
    sed -i "/environment.systemPackages = with pkgs; \[/,/\]/ {
      /\]/ i\    $PACKAGE
    }" "$MY_PKGS_FILE"

    echo "$PACKAGE added to my-pkgs.nix."
  fi
done

# Rebuild NixOS configuration
echo "Rebuilding system with nixos-rebuild switch..."
nixos-rebuild switch


# Author: dampdigits <dampdigits@gmail.com>
